<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Evolix Player</title>
    <link rel="icon" href="/favicon.ico" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --accent: #ffd700;
        --bg-dark: #000;
        --bg-controls: rgba(0, 0, 0, 0.8);
      }

      body {
        background: var(--bg-dark);
        font-family:
          "Rubik",
          -apple-system,
          BlinkMacSystemFont,
          sans-serif;
        overflow: hidden;
      }

      /* Player Container */
      .player-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        background: var(--bg-dark);
      }

      /* Video Element */
      .player-container video {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      /* Loading State */
      .player-loading {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: var(--bg-dark);
        z-index: 100;
      }

      .player-loading.hidden {
        display: none;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 3px solid #333;
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .player-loading p {
        margin-top: 20px;
        color: #888;
        font-size: 14px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Controls Overlay */
      .controls-overlay {
        position: absolute;
        inset: 0;
        opacity: 1;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }

      .controls-overlay.hidden {
        opacity: 0;
      }

      .controls-overlay > * {
        pointer-events: auto;
      }

      /* Top Bar */
      .top-bar {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        padding: 20px 24px;
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0.7) 0%,
          transparent 100%
        );
      }

      .back-button {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: rgba(0, 0, 0, 0.5);
        color: #fff;
        border: 1px solid #444;
        border-radius: 4px;
        cursor: pointer;
        font-family: inherit;
        font-size: 14px;
        transition: all 0.2s;
      }

      .back-button:hover {
        background: var(--accent);
        border-color: var(--accent);
        color: #000;
      }

      .title-area {
        margin-top: 16px;
      }

      .title-area .label {
        color: #888;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .title-area .title {
        color: #fff;
        font-size: 24px;
        font-weight: 700;
        margin-top: 4px;
      }

      .title-area .description {
        color: #aaa;
        font-size: 14px;
        margin-top: 4px;
      }

      /* Center Play Button */
      .center-play {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80px;
        height: 80px;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(4px);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .center-play:hover {
        background: var(--accent);
        transform: translate(-50%, -50%) scale(1.1);
      }

      .center-play svg {
        width: 40px;
        height: 40px;
        fill: #fff;
        margin-left: 4px;
      }

      .center-play:hover svg {
        fill: #000;
      }

      .center-play.hidden {
        display: none;
      }

      /* Bottom Controls */
      .bottom-controls {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 20px 24px;
        background: linear-gradient(
          to top,
          rgba(0, 0, 0, 0.9) 0%,
          transparent 100%
        );
      }

      /* Progress Bar */
      .progress-container {
        width: 100%;
        height: 5px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
        cursor: pointer;
        margin-bottom: 16px;
        position: relative;
      }

      .progress-container:hover {
        height: 8px;
      }

      .progress-buffered {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
      }

      .progress-bar {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        background: var(--accent);
        border-radius: 3px;
      }

      .progress-knob {
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 14px;
        height: 14px;
        background: var(--accent);
        border-radius: 50%;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .progress-container:hover .progress-knob {
        opacity: 1;
      }

      /* Control Buttons */
      .control-buttons {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .control-group {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .control-btn {
        width: 40px;
        height: 40px;
        background: none;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s;
      }

      .control-btn svg {
        width: 24px;
        height: 24px;
        fill: #fff;
        transition: fill 0.2s;
      }

      .control-btn:hover svg {
        fill: var(--accent);
      }

      .time-display {
        color: #fff;
        font-size: 14px;
        font-variant-numeric: tabular-nums;
      }

      /* Volume Slider */
      .volume-container {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .volume-slider {
        width: 0;
        opacity: 0;
        transition: all 0.2s;
        appearance: none;
        height: 4px;
        background: #444;
        border-radius: 2px;
        cursor: pointer;
      }

      .volume-container:hover .volume-slider {
        width: 80px;
        opacity: 1;
      }

      .volume-slider::-webkit-slider-thumb {
        appearance: none;
        width: 12px;
        height: 12px;
        background: var(--accent);
        border-radius: 50%;
        cursor: pointer;
      }

      /* Subtitles Menu */
      .subtitles-menu {
        position: absolute;
        bottom: 80px;
        right: 24px;
        background: rgba(0, 0, 0, 0.95);
        border: 1px solid #333;
        border-radius: 8px;
        min-width: 160px;
        overflow: hidden;
        display: none;
      }

      .subtitles-menu.show {
        display: block;
      }

      .subtitles-menu button {
        width: 100%;
        padding: 12px 16px;
        background: none;
        border: none;
        color: #fff;
        text-align: left;
        cursor: pointer;
        font-family: inherit;
        font-size: 14px;
        transition: background 0.2s;
      }

      .subtitles-menu button:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .subtitles-menu button.active {
        color: var(--accent);
      }

      /* Subtitle Display */
      video::cue {
        background: transparent;
        color: white;
        font-size: 0.85em;
        font-family: "Rubik", sans-serif;
        text-shadow:
          1px 1px 2px rgba(0, 0, 0, 0.9),
          2px 2px 4px rgba(0, 0, 0, 0.9);
      }
    </style>
  </head>
  <body>
    <div class="player-container" id="playerContainer">
      <!-- Loading State -->
      <div class="player-loading" id="loadingState">
        <div class="spinner"></div>
        <p>Loading video...</p>
      </div>

      <!-- Video Element -->
      <video id="video" playsinline></video>

      <!-- Controls Overlay -->
      <div class="controls-overlay" id="controlsOverlay">
        <!-- Top Bar -->
        <div class="top-bar">
          <button class="back-button" onclick="history.back()">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              width="16"
              height="16"
            >
              <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
            Back
          </button>
          <div class="title-area">
            <div class="label">You're Watching</div>
            <div class="title" id="videoTitle">Unknown Title</div>
            <div class="description" id="videoDescription"></div>
          </div>
        </div>

        <!-- Center Play Button -->
        <button class="center-play" id="centerPlay">
          <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z" /></svg>
        </button>

        <!-- Bottom Controls -->
        <div class="bottom-controls">
          <!-- Progress Bar -->
          <div class="progress-container" id="progressContainer">
            <div class="progress-buffered" id="progressBuffered"></div>
            <div class="progress-bar" id="progressBar"></div>
            <div class="progress-knob" id="progressKnob"></div>
          </div>

          <!-- Control Buttons -->
          <div class="control-buttons">
            <div class="control-group">
              <!-- Play/Pause -->
              <button class="control-btn" id="playPauseBtn" title="Play/Pause">
                <svg id="playIcon" viewBox="0 0 24 24">
                  <path d="M8 5v14l11-7z" />
                </svg>
                <svg id="pauseIcon" viewBox="0 0 24 24" style="display: none">
                  <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z" />
                </svg>
              </button>

              <!-- Rewind 10s -->
              <button class="control-btn" id="rewindBtn" title="Rewind 10s">
                <svg viewBox="0 0 24 24">
                  <path
                    d="M12.5 3C17.15 3 21.08 6.03 22.45 10.22L20.04 11c-1.03-3.19-4.05-5.5-7.54-5.5-1.95 0-3.76.7-5.15 1.87L10 10H3V3l2.78 2.78A9.978 9.978 0 0 1 12.5 3zM7 13h2v2H7v-2zm2 4H7v2h2v-2zm2-4h2v6h-2v-6z"
                  />
                </svg>
              </button>

              <!-- Forward 10s -->
              <button class="control-btn" id="forwardBtn" title="Forward 10s">
                <svg viewBox="0 0 24 24" style="transform: scaleX(-1)">
                  <path
                    d="M12.5 3C17.15 3 21.08 6.03 22.45 10.22L20.04 11c-1.03-3.19-4.05-5.5-7.54-5.5-1.95 0-3.76.7-5.15 1.87L10 10H3V3l2.78 2.78A9.978 9.978 0 0 1 12.5 3zM7 13h2v2H7v-2zm2 4H7v2h2v-2zm2-4h2v6h-2v-6z"
                  />
                </svg>
              </button>

              <!-- Volume -->
              <div class="volume-container">
                <button class="control-btn" id="volumeBtn" title="Volume">
                  <svg id="volumeIcon" viewBox="0 0 24 24">
                    <path
                      d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"
                    />
                  </svg>
                  <svg id="muteIcon" viewBox="0 0 24 24" style="display: none">
                    <path
                      d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"
                    />
                  </svg>
                </button>
                <input
                  type="range"
                  class="volume-slider"
                  id="volumeSlider"
                  min="0"
                  max="1"
                  step="0.1"
                  value="1"
                />
              </div>

              <!-- Time Display -->
              <span class="time-display" id="timeDisplay">0:00 / 0:00</span>
            </div>

            <div class="control-group">
              <!-- Subtitles -->
              <button class="control-btn" id="subtitlesBtn" title="Subtitles">
                <svg viewBox="0 0 24 24">
                  <path
                    d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM4 12h4v2H4v-2zm10 6H4v-2h10v2zm6 0h-4v-2h4v2zm0-4H10v-2h10v2z"
                  />
                </svg>
              </button>

              <!-- Fullscreen -->
              <button class="control-btn" id="fullscreenBtn" title="Fullscreen">
                <svg id="enterFullscreen" viewBox="0 0 24 24">
                  <path
                    d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"
                  />
                </svg>
                <svg
                  id="exitFullscreen"
                  viewBox="0 0 24 24"
                  style="display: none"
                >
                  <path
                    d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Subtitles Menu -->
        <div class="subtitles-menu" id="subtitlesMenu"></div>
      </div>
    </div>

    <script>
      // Get video data from URL
      function getPlayerData() {
        const urlParams = new URLSearchParams(window.location.search);
        const encodedData = urlParams.get("data");
        if (!encodedData) return null;
        try {
          const jsonString = decodeURIComponent(
            escape(atob(decodeURIComponent(encodedData)))
          );
          return JSON.parse(jsonString);
        } catch (e) {
          console.error("Failed to decode data:", e);
          return null;
        }
      }

      // Format time
      function formatTime(seconds) {
        if (!seconds || isNaN(seconds)) return "0:00";
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        if (h > 0) {
          return `${h}:${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
        }
        return `${m}:${s.toString().padStart(2, "0")}`;
      }

      // Initialize player
      function initPlayer() {
        const data = getPlayerData();
        const video = document.getElementById("video");
        const loading = document.getElementById("loadingState");
        const controls = document.getElementById("controlsOverlay");
        const centerPlay = document.getElementById("centerPlay");

        if (!data || !data.sources || data.sources.length === 0) {
          loading.innerHTML = `
                    <h2 style="color: var(--accent);">Error Loading Video</h2>
                    <p style="color: #888; margin-top: 10px;">No video data found.</p>
                    <button onclick="history.back()" style="margin-top: 20px; padding: 12px 24px; background: var(--accent); color: #000; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-family: inherit;">Go Back</button>
                `;
          return;
        }

        // Set title
        document.getElementById("videoTitle").textContent =
          data.title || "Unknown Title";
        document.getElementById("videoDescription").textContent =
          data.description || "";
        document.title = `${data.title || "Video"} - Evolix Player`;

        // Set video source and enable autoplay
        video.src = data.sources[0].file;
        video.autoplay = true;
        if (data.poster) video.poster = data.poster;

        // Add subtitles
        if (data.captions && data.captions.length > 0) {
          data.captions.forEach((caption, index) => {
            const track = document.createElement("track");
            track.kind = "captions";
            track.src = caption.file;
            track.srclang = caption.label.substring(0, 2).toLowerCase();
            track.label = caption.label;
            if (caption.default) track.default = true;
            video.appendChild(track);
          });

          // Build subtitles menu
          const menu = document.getElementById("subtitlesMenu");
          menu.innerHTML =
            '<button class="active" data-index="-1">Off</button>';
          data.captions.forEach((caption, index) => {
            menu.innerHTML += `<button data-index="${index}">${caption.label}</button>`;
          });
        }

        // Video events
        video.addEventListener("canplay", () => {
          loading.classList.add("hidden");
        });

        video.addEventListener("waiting", () => {
          loading.classList.remove("hidden");
        });

        video.addEventListener("playing", () => {
          loading.classList.add("hidden");
        });

        video.addEventListener("play", () => {
          centerPlay.classList.add("hidden");
          document.getElementById("playIcon").style.display = "none";
          document.getElementById("pauseIcon").style.display = "block";
        });

        video.addEventListener("pause", () => {
          centerPlay.classList.remove("hidden");
          document.getElementById("playIcon").style.display = "block";
          document.getElementById("pauseIcon").style.display = "none";
        });

        video.addEventListener("timeupdate", () => {
          const progress = (video.currentTime / video.duration) * 100;
          document.getElementById("progressBar").style.width = progress + "%";
          document.getElementById("progressKnob").style.left = progress + "%";
          document.getElementById("timeDisplay").textContent =
            `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
        });

        video.addEventListener("progress", () => {
          if (video.buffered.length > 0) {
            const buffered =
              (video.buffered.end(video.buffered.length - 1) / video.duration) *
              100;
            document.getElementById("progressBuffered").style.width =
              buffered + "%";
          }
        });

        // Controls
        document
          .getElementById("playPauseBtn")
          .addEventListener("click", () => {
            video.paused ? video.play() : video.pause();
          });

        centerPlay.addEventListener("click", () => video.play());
        video.addEventListener("click", () =>
          video.paused ? video.play() : video.pause()
        );
        video.addEventListener("dblclick", toggleFullscreen);

        document.getElementById("rewindBtn").addEventListener("click", () => {
          video.currentTime = Math.max(0, video.currentTime - 10);
        });

        document.getElementById("forwardBtn").addEventListener("click", () => {
          video.currentTime = Math.min(video.duration, video.currentTime + 10);
        });

        // Volume
        const volumeSlider = document.getElementById("volumeSlider");
        document.getElementById("volumeBtn").addEventListener("click", () => {
          video.muted = !video.muted;
          updateVolumeIcon();
        });

        volumeSlider.addEventListener("input", (e) => {
          video.volume = e.target.value;
          video.muted = false;
          updateVolumeIcon();
        });

        function updateVolumeIcon() {
          document.getElementById("volumeIcon").style.display = video.muted
            ? "none"
            : "block";
          document.getElementById("muteIcon").style.display = video.muted
            ? "block"
            : "none";
          volumeSlider.value = video.muted ? 0 : video.volume;
        }

        // Progress seek
        document
          .getElementById("progressContainer")
          .addEventListener("click", (e) => {
            const rect = e.currentTarget.getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            video.currentTime = pos * video.duration;
          });

        // Fullscreen
        document
          .getElementById("fullscreenBtn")
          .addEventListener("click", toggleFullscreen);

        function toggleFullscreen() {
          if (!document.fullscreenElement) {
            document.getElementById("playerContainer").requestFullscreen();
          } else {
            document.exitFullscreen();
          }
        }

        document.addEventListener("fullscreenchange", () => {
          const isFs = !!document.fullscreenElement;
          document.getElementById("enterFullscreen").style.display = isFs
            ? "none"
            : "block";
          document.getElementById("exitFullscreen").style.display = isFs
            ? "block"
            : "none";
        });

        // Subtitles
        const subtitlesBtn = document.getElementById("subtitlesBtn");
        const subtitlesMenu = document.getElementById("subtitlesMenu");

        subtitlesBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          subtitlesMenu.classList.toggle("show");
        });

        subtitlesMenu.addEventListener("click", (e) => {
          if (e.target.tagName === "BUTTON") {
            const index = parseInt(e.target.dataset.index);
            for (let i = 0; i < video.textTracks.length; i++) {
              video.textTracks[i].mode = i === index ? "showing" : "disabled";
            }
            subtitlesMenu
              .querySelectorAll("button")
              .forEach((b) => b.classList.remove("active"));
            e.target.classList.add("active");
            subtitlesMenu.classList.remove("show");
          }
        });

        // Hide controls on inactivity
        let hideTimeout;
        function showControls() {
          controls.classList.remove("hidden");
          clearTimeout(hideTimeout);
          if (!video.paused) {
            hideTimeout = setTimeout(() => {
              controls.classList.add("hidden");
              subtitlesMenu.classList.remove("show");
            }, 3000);
          }
        }

        document
          .getElementById("playerContainer")
          .addEventListener("mousemove", showControls);
        document
          .getElementById("playerContainer")
          .addEventListener("click", showControls);

        // Keyboard shortcuts
        document.addEventListener("keydown", (e) => {
          switch (e.key) {
            case " ":
            case "k":
              e.preventDefault();
              video.paused ? video.play() : video.pause();
              break;
            case "ArrowLeft":
              video.currentTime -= 10;
              break;
            case "ArrowRight":
              video.currentTime += 10;
              break;
            case "ArrowUp":
              e.preventDefault();
              video.volume = Math.min(1, video.volume + 0.1);
              break;
            case "ArrowDown":
              e.preventDefault();
              video.volume = Math.max(0, video.volume - 0.1);
              break;
            case "m":
              video.muted = !video.muted;
              updateVolumeIcon();
              break;
            case "f":
              toggleFullscreen();
              break;
            case "Escape":
              if (!document.fullscreenElement) history.back();
              break;
          }
          showControls();
        });
      }

      // Start
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initPlayer);
      } else {
        initPlayer();
      }
    </script>
  </body>
</html>
